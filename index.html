<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UBL Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #111827;
            color: #ffffff;
            font-family: Arial, sans-serif;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 32px;
            color: #60a5fa;
        }

        .header-right {
            text-align: right;
        }

        .refresh-btn {
            background-color: #2563eb;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }

        .refresh-btn:hover {
            background-color: #1d4ed8;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin: 24px 0;
        }

        .stat-card {
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-total {
            background: linear-gradient(135deg, #1e40af, #1e3a8a);
        }

        .stat-present {
            background: linear-gradient(135deg, #059669, #047857);
        }

        .stat-late {
            background: linear-gradient(135deg, #d97706, #b45309);
        }

        .stat-sick {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
        }

        .stat-annual {
            background: linear-gradient(135deg, #4f46e5, #4338ca);
        }

        .stat-proxy {
            background: linear-gradient(135deg, #dc2626, #991b1b);
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
        }

        .table-container {
            background-color: #1f2937;
            border: 1px solid #374151;
            border-radius: 8px;
            margin-top: 24px;
            overflow: hidden;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            padding: 16px 24px;
            border-bottom: 1px solid #374151;
            background-color: #111827;
        }

        .export-btn {
            background-color: #16a34a;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .export-btn:hover {
            background-color: #15803d;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: #374151;
            padding: 12px;
            text-align: left;
            font-weight: bold;
            border-bottom: 1px solid #4b5563;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #374151;
        }

        tr:hover {
            background-color: #273345;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-present {
            background-color: #064e3b;
            color: #86efac;
        }

        .badge-late {
            background-color: #78350f;
            color: #fef08a;
        }

        .badge-other {
            background-color: #374151;
            color: #d1d5db;
        }

        .proxy-ok {
            color: #4ade80;
        }

        .proxy-alert {
            color: #f87171;
        }

        .empty {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }

        .error {
            background-color: #7f1d1d;
            color: #fecaca;
            padding: 16px;
            border-radius: 5px;
            margin: 16px 0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #60a5fa;
        }

        .success {
            background-color: #064e3b;
            color: #86efac;
            padding: 16px;
            border-radius: 5px;
            margin: 16px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üìä Admin Dashboard</h1>
                <p style="color: #9ca3af;">L&D Department Attendance Monitor</p>
            </div>
            <div class="header-right">
                <p style="font-size: 14px; color: #9ca3af;">Last updated: <span id="lastUpdated">--:--:--</span></p>
                <button class="refresh-btn" onclick="loadData()">üîÑ Refresh Now</button>
            </div>
        </div>

        <div id="successMsg" class="success" style="display: none;"></div>
        <div id="errorMsg" class="error" style="display: none;"></div>

        <div id="loadingMsg" class="loading">
            ‚è≥ Loading attendance data...
        </div>

        <div id="statsContainer" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card stat-total">
                    <div class="stat-label">Total Submitted</div>
                    <div class="stat-value" id="stat-total">0</div>
                </div>
                <div class="stat-card stat-present">
                    <div class="stat-label">Present</div>
                    <div class="stat-value" id="stat-present">0</div>
                </div>
                <div class="stat-card stat-late">
                    <div class="stat-label">Late</div>
                    <div class="stat-value" id="stat-late">0</div>
                </div>
                <div class="stat-card stat-sick">
                    <div class="stat-label">Sick/Personal</div>
                    <div class="stat-value" id="stat-sick">0</div>
                </div>
                <div class="stat-card stat-annual">
                    <div class="stat-label">Annual Leave</div>
                    <div class="stat-value" id="stat-annual">0</div>
                </div>
                <div class="stat-card stat-proxy">
                    <div class="stat-label">Proxy Alerts</div>
                    <div class="stat-value" id="stat-proxy">0</div>
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <h2 style="margin: 0;">Today's Attendance Records</h2>
                    <button class="export-btn" onclick="exportData()">üì• Export CSV</button>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Cluster</th>
                                <th>Name</th>
                                <th>Status</th>
                                <th>Time</th>
                                <th>Location</th>
                                <th>Proxy Alert</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="6" class="empty">No data loaded yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyjgb7lTC1YaON02CXgddYYLXZyUgZcrsa7gPn3-SOqFQSIhXFoB5M3slgrATyVM67F/exec';
        let allData = [];

        async function loadData() {
            console.log('Loading data from Apps Script...');
            document.getElementById('loadingMsg').style.display = 'block';
            document.getElementById('statsContainer').style.display = 'none';
            document.getElementById('errorMsg').style.display = 'none';
            document.getElementById('successMsg').style.display = 'none';

            try {
                const response = await fetch(APPS_SCRIPT_URL);
                
                if (!response.ok) {
                    throw new Error('HTTP error, status: ' + response.status);
                }

                const jsonData = await response.json();
                console.log('Response:', jsonData);

                if (jsonData.error) {
                    throw new Error(jsonData.error);
                }

                if (!Array.isArray(jsonData)) {
                    throw new Error('Response is not an array');
                }

                allData = jsonData.map(row => {
                    // Parse date and time - they might be combined or in ISO format
                    let dateStr = row['Date'] || '';
                    let timeStr = row['Time'] || '';
                    
                    // Convert ISO time to readable format
                    if (timeStr && timeStr.includes('T')) {
                        try {
                            const timeDate = new Date(timeStr);
                            timeStr = timeDate.toLocaleTimeString('en-US', { 
                                hour: 'numeric', 
                                minute: '2-digit',
                                hour12: true 
                            });
                        } catch (e) {
                            console.error('Time parse error:', e);
                        }
                    }
                    
                    // If time is in the date field, split them
                    if (dateStr && dateStr.match(/\d{1,2}\/\d{1,2}\/\d{4}\d/)) {
                        // Format: "11/30/20251:25:14 AM"
                        const match = dateStr.match(/^(\d{1,2}\/\d{1,2}\/\d{4})(.*)/);
                        if (match) {
                            dateStr = match[1];
                            if (match[2] && !timeStr) timeStr = match[2];
                        }
                    }
                    
                    return {
                        cluster: row['Cluster'] || '',
                        name: row['Name'] || '',
                        status: row['Status'] || '',
                        date: dateStr,
                        time: timeStr,
                        latitude: row['Latitude'] || '',
                        longitude: row['Longitude'] || '',
                        address: row['Address'] || '',
                        notes: row['Notes'] || '',
                        proxyAlert: row['Proxy Alert'] || '‚úÖ OK'
                    };
                }).filter(row => row.name); // Filter out empty rows

                console.log('Parsed data:', allData.length, 'records');
                updateUI();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('errorMsg').textContent = '‚ùå Error: ' + error.message;
                document.getElementById('errorMsg').style.display = 'block';
                document.getElementById('loadingMsg').style.display = 'none';
            }
        }

        function updateUI() {
            const now = new Date();
            const today = now.toLocaleDateString('en-US');
            console.log('Today:', today);
            console.log('All data:', allData);
            
            // Filter data - handle ISO date format from Google Sheets
            let todayData = allData.filter(r => {
                if (!r.date) return false;
                
                // Parse the date from ISO format
                let recordDate;
                try {
                    if (r.date.includes('T')) {
                        // ISO format: "2025-11-11T19:00:00.000Z"
                        recordDate = new Date(r.date);
                    } else {
                        // Regular format: "11/30/2025"
                        recordDate = new Date(r.date);
                    }
                    
                    const recordDateStr = recordDate.toLocaleDateString('en-US');
                    return recordDateStr === today;
                } catch (e) {
                    console.error('Date parse error:', e, r.date);
                    return false;
                }
            });
            
            console.log('Today data:', todayData.length, 'records');

            document.getElementById('loadingMsg').style.display = 'none';
            document.getElementById('statsContainer').style.display = 'block';
            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
            document.getElementById('successMsg').textContent = '‚úÖ Data loaded! Today: ' + todayData.length + ' records (Total: ' + allData.length + ')';
            document.getElementById('successMsg').style.display = 'block';

            const stats = {
                total: todayData.length,
                present: todayData.filter(r => r.status === 'Present').length,
                late: todayData.filter(r => r.status === 'Late').length,
                sick: todayData.filter(r => r.status && r.status.includes('Personal/Sick')).length,
                annual: todayData.filter(r => r.status === 'Annual Leave').length,
                proxy: todayData.filter(r => r.proxyAlert && r.proxyAlert !== '‚úÖ OK').length
            };

            document.getElementById('stat-total').textContent = stats.total;
            document.getElementById('stat-present').textContent = stats.present;
            document.getElementById('stat-late').textContent = stats.late;
            document.getElementById('stat-sick').textContent = stats.sick;
            document.getElementById('stat-annual').textContent = stats.annual;
            document.getElementById('stat-proxy').textContent = stats.proxy;

            updateTable(todayData);
        }

        function updateTable(data) {
            const tbody = document.getElementById('tableBody');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty">No attendance records for today</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(r => `
                <tr>
                    <td>${r.cluster || '-'}</td>
                    <td>${r.name || '-'}</td>
                    <td>
                        <span class="status-badge ${
                            r.status === 'Present' ? 'badge-present' :
                            r.status === 'Late' ? 'badge-late' :
                            'badge-other'
                        }">${r.status || '-'}</span>
                    </td>
                    <td>${r.time || '-'}</td>
                    <td style="font-size: 12px; color: #9ca3af;">${(r.address || '').substring(0, 40)}</td>
                    <td>${
                        r.proxyAlert === '‚úÖ OK' ? 
                        '<span class="proxy-ok">‚úÖ OK</span>' :
                        '<span class="proxy-alert">' + (r.proxyAlert || '').substring(0, 20) + '...</span>'
                    }</td>
                </tr>
            `).join('');
        }

        function exportData() {
            const today = new Date().toLocaleDateString('en-US');
            const todayData = allData.filter(r => r.date === today);

            if (todayData.length === 0) {
                alert('No data to export for today');
                return;
            }

            const headers = ['Cluster', 'Name', 'Status', 'Date', 'Time', 'Latitude', 'Longitude', 'Address', 'Notes', 'Proxy Alert'];
            const csv = [headers.join(',')];

            todayData.forEach(r => {
                csv.push([
                    r.cluster,
                    r.name,
                    r.status,
                    r.date,
                    r.time,
                    r.latitude,
                    r.longitude,
                    r.address,
                    r.notes,
                    r.proxyAlert
                ].map(v => `"${v}"`).join(','));
            });

            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_${today}.csv`;
            a.click();
        }

        // Load on page load
        window.addEventListener('load', loadData);
        
        // Auto refresh every 30 seconds
        setInterval(loadData, 30000);
    </script>
</body>
</html>
